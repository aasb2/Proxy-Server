from socket import *
#Bibliotecas Necessárias para criar threads
#import logging
import threading
import time


'''
def thread(name):
    logging.info("Thread %s: starting", name)
    time.sleep(2)
    logging.info("Thead %s: finishing", name)
    print("It is me thread: ",i)



threads = []
for i in range(100):
    x = threading.Thread(target = thread, args = (i,))
    threads.append(x)
    x.start()
'''




def findHost(request:str) -> str:
    length = len('Host: ')
    start = request.find('Host: ')
    if(start == -1):
        return None
    end = request.find('\r\n',start+length,len(request)-1)
    host = request[start+length:end]
    return host

def findHTTP(request:str) -> str:
    length = len('HTTP/')
    start = request.find('HTTP/')
    end = request.find('\r\n')
    return request[start+length:end]

def requestWeb(connectionSocket = None, addr = None, thread = None):
    print("Starting Thread: ",thread)
    
    connection = True
    #Recebe requisição do cliente
    try:
        request = connectionSocket.recv(1024).decode()
        print("From Client: ",request)
        #encontra a versão HTTP
        version = findHTTP(request)
        #Encontra o host no request do cliente
        host = findHost(request)
        print(host)
        #Inicia conexão com o servidor web
        send_request_socket = socket(AF_INET, SOCK_STREAM)
        send_request_socket.connect((host,80)) 
        #Envia a primeira requisição ao servidor Web
        send_request_socket.send(request.encode())
        #Retorna a primeira página requisitada pelo cliente
        web_page = send_request_socket.recv(1024)
        connectionSocket.send(web_page)
        #Caso o cliente continue a conexão
        if version!= 1.0:
            while connection:
                #print(rq)
                try:
                    rq = connectionSocket.recv(1024)
                    if rq == '':
                        break
                    request = rq.decode()
                    print("From Client: ",request)
                    #Exceção em caso de fechar o servidor web
                    send_request_socket.send(request.encode())
                    web_page = send_request_socket.recv(1024)
                    connectionSocket.send(web_page)
                except timeout as e:
                    print(e)
                    break
    except timeout as e:
        print(e)
    send_request_socket.close()
    connectionSocket.close()
    print("Closing Thread: ",thread)
    


serverPort = 13000
serverSocket = socket(AF_INET, SOCK_STREAM)
serverSocket.bind(('', serverPort))
serverSocket.listen(1)
print("The server is ready to receive")
th_num = 0

while True:
  connectionSocket, addr = serverSocket.accept() 
  connectionSocket.settimeout(10)
  print("creating thread: ", th_num)
  thread = threading.Thread(target = requestWeb, kwargs = dict(connectionSocket = connectionSocket, addr = addr, thread = th_num))
  th_num += 1
  thread.start()




